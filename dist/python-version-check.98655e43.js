import e from"./python-version-check.64bbae24.js";import t from"./python-version-check.f95b0f32.js";import s from"./python-version-check.92967d43.js";import i from"./python-version-check.1bc0acd6.js";import{Writable as o}from"stream";import{channel as n}from"diagnostics_channel";var f={},h=o,r=$ht4UQ$pythonversioncheck64bbae24js2.parserStates,a=$ht4UQ$pythonversioncheck64bbae24js1.opcodes,c=e.states,d=$ht4UQ$pythonversioncheck64bbae24js.emptyBuffer,l=$ht4UQ$pythonversioncheckf95b0f32js.kReadyState,u=t.kSentClose,p=$ht4UQ$pythonversioncheckf95b0f32js2.kResponse,b=$ht4UQ$pythonversioncheckf95b0f32js1.kReceivedClose,y=$ht4UQ$pythonversioncheck92967d43js1.isValidStatusCode,g=$ht4UQ$pythonversioncheck92967d43js.failWebsocketConnection,m=s.websocketMessageReceived,A=i.WebsocketFrameSend;let O={};O.ping=n("undici:websocket:ping"),O.pong=n("undici:websocket:pong");class _ extends h{#e=[];#t=0;#s=r.INFO;#i={};#o=[];constructor(e){super(),this.ws=e}_write(e,t,s){this.#e.push(e),this.#t+=e.length,this.run(s)}run(e){for(;;){if(this.#s===r.INFO){if(this.#t<2)return e();let t=this.consume(2);if(this.#i.fin=(128&t[0])!=0,this.#i.opcode=15&t[0],this.#i.originalOpcode??=this.#i.opcode,this.#i.fragmented=!this.#i.fin&&this.#i.opcode!==a.CONTINUATION,this.#i.fragmented&&this.#i.opcode!==a.BINARY&&this.#i.opcode!==a.TEXT)return void g(this.ws,"Invalid frame type was fragmented.");let s=127&t[1];if(s<=125?(this.#i.payloadLength=s,this.#s=r.READ_DATA):126===s?this.#s=r.PAYLOADLENGTH_16:127===s&&(this.#s=r.PAYLOADLENGTH_64),this.#i.fragmented&&s>125)return void g(this.ws,"Fragmented frame exceeded 125 bytes.");if((this.#i.opcode===a.PING||this.#i.opcode===a.PONG||this.#i.opcode===a.CLOSE)&&s>125)return void g(this.ws,"Payload length for control frame exceeded 125 bytes.");if(this.#i.opcode===a.CLOSE){if(1===s)return void g(this.ws,"Received close frame with a 1-byte body.");let e=this.consume(s);if(this.#i.closeInfo=this.parseCloseBody(!1,e),!this.ws[u]){let e=Buffer.allocUnsafe(2);e.writeUInt16BE(this.#i.closeInfo.code,0);let t=new A(e);this.ws[p].socket.write(t.createFrame(a.CLOSE),e=>{e||(this.ws[u]=!0)})}this.ws[l]=c.CLOSING,this.ws[b]=!0,this.end();return}else if(this.#i.opcode===a.PING){let t=this.consume(s);if(!this.ws[b]){let e=new A(t);this.ws[p].socket.write(e.createFrame(a.PONG)),O.ping.hasSubscribers&&O.ping.publish({payload:t})}if(this.#s=r.INFO,this.#t>0)continue;return void e()}else if(this.#i.opcode===a.PONG){let t=this.consume(s);if(O.pong.hasSubscribers&&O.pong.publish({payload:t}),this.#t>0)continue;return void e()}}else if(this.#s===r.PAYLOADLENGTH_16){if(this.#t<2)return e();let t=this.consume(2);this.#i.payloadLength=t.readUInt16BE(0),this.#s=r.READ_DATA}else if(this.#s===r.PAYLOADLENGTH_64){if(this.#t<8)return e();let t=this.consume(8),s=t.readUInt32BE(0);if(s>0x80000000-1)return void g(this.ws,"Received payload length > 2^31 bytes.");let i=t.readUInt32BE(4);this.#i.payloadLength=(s<<8)+i,this.#s=r.READ_DATA}else if(this.#s===r.READ_DATA){if(this.#t<this.#i.payloadLength)return e();else if(this.#t>=this.#i.payloadLength){let e=this.consume(this.#i.payloadLength);if(this.#o.push(e),!this.#i.fragmented||this.#i.fin&&this.#i.opcode===a.CONTINUATION){let e=Buffer.concat(this.#o);m(this.ws,this.#i.originalOpcode,e),this.#i={},this.#o.length=0}this.#s=r.INFO}}if(!(this.#t>0)){e();break}}}consume(e){if(e>this.#t)return null;if(0===e)return d;if(this.#e[0].length===e)return this.#t-=this.#e[0].length,this.#e.shift();let t=Buffer.allocUnsafe(e),s=0;for(;s!==e;){let i=this.#e[0],{length:o}=i;if(o+s===e){t.set(this.#e.shift(),s);break}if(o+s>e){t.set(i.subarray(0,e-s),s),this.#e[0]=i.subarray(e-s);break}t.set(this.#e.shift(),s),s+=i.length}return this.#t-=e,t}parseCloseBody(e,t){let s;if(t.length>=2&&(s=t.readUInt16BE(0)),e)return y(s)?{code:s}:null;let i=t.subarray(2);if(239===i[0]&&187===i[1]&&191===i[2]&&(i=i.subarray(3)),void 0!==s&&!y(s))return null;try{i=new TextDecoder("utf-8",{fatal:!0}).decode(i)}catch{return null}return{code:s,reason:i}}get closingInfo(){return this.#i.closeInfo}}f={ByteParser:_};export{f as default};
//# sourceMappingURL=python-version-check.98655e43.js.map
