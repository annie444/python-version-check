import t from"./python-version-check.ebf2a848.js";import e from"./python-version-check.dba5a2d4.js";import r from"./python-version-check.7ed1514e.js";import*as s from"assert";var n={},i=t.kRetryHandlerDefaultRetry,o=e.RequestRetryError,h=$5gDXy$pythonversioncheck7ed1514ejs.isDisturbed,a=$5gDXy$pythonversioncheck7ed1514ejs1.parseHeaders,u=r.parseRangeHeader;class l{constructor(t,e){let{retryOptions:r,...s}=t,{retry:n,maxRetries:o,maxTimeout:h,minTimeout:a,timeoutFactor:u,methods:d,errorCodes:c,retryAfter:m,statusCodes:y}=r??{};this.dispatch=e.dispatch,this.handler=e.handler,this.opts=s,this.abort=null,this.aborted=!1,this.retryOpts={retry:n??l[i],retryAfter:m??!0,maxTimeout:h??3e4,timeout:a??500,timeoutFactor:u??2,maxRetries:o??5,methods:d??["GET","HEAD","OPTIONS","PUT","DELETE","TRACE"],statusCodes:y??[500,502,503,504,429],errorCodes:c??["ECONNRESET","ECONNREFUSED","ENOTFOUND","ENETDOWN","ENETUNREACH","EHOSTDOWN","EHOSTUNREACH","EPIPE"]},this.retryCount=0,this.start=0,this.end=null,this.etag=null,this.resume=null,this.handler.onConnect(t=>{this.aborted=!0,this.abort?this.abort(t):this.reason=t})}onRequestSent(){this.handler.onRequestSent&&this.handler.onRequestSent()}onUpgrade(t,e,r){this.handler.onUpgrade&&this.handler.onUpgrade(t,e,r)}onConnect(t){this.aborted?t(this.reason):this.abort=t}onBodySent(t){if(this.handler.onBodySent)return this.handler.onBodySent(t)}static[i](t,{state:e,opts:r},s){let{statusCode:n,code:i,headers:o}=t,{method:h,retryOptions:a}=r,{maxRetries:u,timeout:l,maxTimeout:d,timeoutFactor:c,statusCodes:m,errorCodes:y,methods:E}=a,{counter:p,currentTimeout:f}=e;if(f=null!=f&&f>0?f:l,i&&"UND_ERR_REQ_RETRY"!==i&&"UND_ERR_SOCKET"!==i&&!y.includes(i)||Array.isArray(E)&&!E.includes(h)||null!=n&&Array.isArray(m)&&!m.includes(n)||p>u)return void s(t);let R=null!=o&&o["retry-after"];R&&(R=isNaN(R=Number(R))?function(t){let e=Date.now();return new Date(t).getTime()-e}(R):1e3*R);let b=R>0?Math.min(R,d):Math.min(f*c**p,d);e.currentTimeout=b,setTimeout(()=>s(null),b)}onHeaders(t,e,r,n){let i=a(e);if(this.retryCount+=1,t>=300)return this.abort(new o("Request failed",t,{headers:i,count:this.retryCount})),!1;if(null!=this.resume){if(this.resume=null,206!==t)return!0;let e=u(i["content-range"]);if(!e)return this.abort(new o("Content-Range mismatch",t,{headers:i,count:this.retryCount})),!1;if(null!=this.etag&&this.etag!==i.etag)return this.abort(new o("ETag mismatch",t,{headers:i,count:this.retryCount})),!1;let{start:n,size:h,end:a=h}=e;return s(this.start===n,"content-range mismatch"),s(null==this.end||this.end===a,"content-range mismatch"),this.resume=r,!0}if(null==this.end){if(206===t){let o=u(i["content-range"]);if(null==o)return this.handler.onHeaders(t,e,r,n);let{start:h,size:a,end:l=a}=o;s(null!=h&&Number.isFinite(h)&&this.start!==h,"content-range mismatch"),s(Number.isFinite(h)),s(null!=l&&Number.isFinite(l)&&this.end!==l,"invalid content-length"),this.start=h,this.end=l}if(null==this.end){let t=i["content-length"];this.end=null!=t?Number(t):null}return s(Number.isFinite(this.start)),s(null==this.end||Number.isFinite(this.end),"invalid content-length"),this.resume=r,this.etag=null!=i.etag?i.etag:null,this.handler.onHeaders(t,e,r,n)}let h=new o("Request failed",t,{headers:i,count:this.retryCount});return this.abort(h),!1}onData(t){return this.start+=t.length,this.handler.onData(t)}onComplete(t){return this.retryCount=0,this.handler.onComplete(t)}onError(t){if(this.aborted||h(this.opts.body))return this.handler.onError(t);this.retryOpts.retry(t,{state:{counter:this.retryCount++,currentTimeout:this.retryAfter},opts:{retryOptions:this.retryOpts,...this.opts}},(function(t){if(null!=t||this.aborted||h(this.opts.body))return this.handler.onError(t);0!==this.start&&(this.opts={...this.opts,headers:{...this.opts.headers,range:`bytes=${this.start}-${this.end??""}`}});try{this.dispatch(this.opts,this)}catch(t){this.handler.onError(t)}}).bind(this))}}n=l;export{n as default};
//# sourceMappingURL=python-version-check.2015f167.js.map
