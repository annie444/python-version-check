import t from"./python-version-check.dba5a2d4.js";import e from"./python-version-check.9d13d3dd.js";import s from"./python-version-check.91f60e5c.js";import i from"./python-version-check.ebf2a848.js";import r from"./python-version-check.7ed1514e.js";var o={},n=$jdVRa$pythonversioncheckdba5a2d4js.BalancedPoolMissingUpstreamError,h=t.InvalidArgumentError,c=e.PoolBase,a=$jdVRa$pythonversioncheck9d13d3ddjs1.kClients,d=$jdVRa$pythonversioncheck9d13d3ddjs3.kNeedDrain,l=$jdVRa$pythonversioncheck9d13d3ddjs.kAddClient,p=$jdVRa$pythonversioncheck9d13d3ddjs4.kRemoveClient,f=$jdVRa$pythonversioncheck9d13d3ddjs2.kGetDispatcher,m=i.kUrl,y=$jdVRa$pythonversioncheckebf2a848js.kInterceptors,_=r.parseOrigin;let S=Symbol("factory"),u=Symbol("options"),k=Symbol("kGreatestCommonDivisor"),H=Symbol("kCurrentWeight"),R=Symbol("kIndex"),j=Symbol("kWeight"),v=Symbol("kMaxWeightPerServer"),A=Symbol("kErrorPenalty");function E(t,e){return new s(t,e)}o=class extends c{constructor(t=[],{factory:e=E,...s}={}){if(super(),this[u]=s,this[R]=-1,this[H]=0,this[v]=this[u].maxWeightPerServer||100,this[A]=this[u].errorPenalty||15,Array.isArray(t)||(t=[t]),"function"!=typeof e)throw new h("factory must be a function.");for(let i of(this[y]=s.interceptors&&s.interceptors.BalancedPool&&Array.isArray(s.interceptors.BalancedPool)?s.interceptors.BalancedPool:[],this[S]=e,t))this.addUpstream(i);this._updateBalancedPoolStats()}addUpstream(t){let e=_(t).origin;if(this[a].find(t=>t[m].origin===e&&!0!==t.closed&&!0!==t.destroyed))return this;let s=this[S](e,Object.assign({},this[u]));for(let t of(this[l](s),s.on("connect",()=>{s[j]=Math.min(this[v],s[j]+this[A])}),s.on("connectionError",()=>{s[j]=Math.max(1,s[j]-this[A]),this._updateBalancedPoolStats()}),s.on("disconnect",(...t)=>{let e=t[2];e&&"UND_ERR_SOCKET"===e.code&&(s[j]=Math.max(1,s[j]-this[A]),this._updateBalancedPoolStats())}),this[a]))t[j]=this[v];return this._updateBalancedPoolStats(),this}_updateBalancedPoolStats(){this[k]=this[a].map(t=>t[j]).reduce(function t(e,s){return 0===s?e:t(s,e%s)},0)}removeUpstream(t){let e=_(t).origin,s=this[a].find(t=>t[m].origin===e&&!0!==t.closed&&!0!==t.destroyed);return s&&this[p](s),this}get upstreams(){return this[a].filter(t=>!0!==t.closed&&!0!==t.destroyed).map(t=>t[m].origin)}[f](){if(0===this[a].length)throw new n;if(!this[a].find(t=>!t[d]&&!0!==t.closed&&!0!==t.destroyed)||this[a].map(t=>t[d]).reduce((t,e)=>t&&e,!0))return;let t=0,e=this[a].findIndex(t=>!t[d]);for(;t++<this[a].length;){this[R]=(this[R]+1)%this[a].length;let t=this[a][this[R]];if(t[j]>this[a][e][j]&&!t[d]&&(e=this[R]),0===this[R]&&(this[H]=this[H]-this[k],this[H]<=0&&(this[H]=this[v])),t[j]>=this[H]&&!t[d])return t}return this[H]=this[a][e][j],this[R]=e,this[a][e]}};export{o as default};
//# sourceMappingURL=python-version-check.8b2dc8ee.js.map
